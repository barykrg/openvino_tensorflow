
    
 pool:
  name: 'Default'
  
 variables:
    WORK_DIR: /opt/intel/temp/openvino_tensorflow
    BUILD_DIR: $(WORK_DIR)/build
    OV_DIR: /opt/intel/openvino_2021.3.394/
    TF_DIR: /home/tf_m1
    
 steps:
 
   - script: |
      rm -rf /opt/intel/temp ; mkdir /opt/intel/temp
     displayName: "Directory Creation and removal" 
   

   - script: |
      pip install -U pip yapf==0.26.0 pytest psutil keras==2.3.1
     displayName: "Setup" 
    
   - script: |
      git clone  https://github.com/openvinotoolkit/openvino_tensorflow.git $(WORK_DIR)
      cd $(WORK_DIR) && git submodule init
      cd $(WORK_DIR) && git submodule update --recursive
      cd $(WORK_DIR) && python3.8 build_ovtf.py --use_tensorflow_from_location=${TF_DIR} --use_openvino_from_location=${OV_DIR} --disable_packaging_openvino_libs --cxx11_abi_version=1
      ${OV_DIR}/install_dependencies/install_NEO_OCL_driver.sh -y
      ${OV_DIR}/install_dependencies/install_NCS_udev_rules.sh
     displayName: "Build"
     
   - script: |
      source ${OV_DIR}/bin/setupvars.sh
      source ${WORK_DIR}/build_cmake/venv-tf-py3/bin/activate
      PYTHONPATH=`pwd` python3 test/ci/azure/test_runner.py \
      --artifacts ${WORK_DIR}/build_cmake/artifacts/ --test_cpp
      exit_code=$?
      echo "Exit Result for tf_ov C++ Tests is ${exit_code}"
     workingDirectory: $(WORK_DIR) 
     displayName: "tf_ov C++ Tests"

   - script: |
      export OPENVINO_TF_BACKEND=GPU
      source ${OV_DIR}/bin/setupvars.sh
      source ${WORK_DIR}/build_cmake/venv-tf-py3/bin/activate
      cd ${WORK_DIR}/test/ci/azure/
      bash run_inception_v3.sh ${WORK_DIR}/build_cmake/artifacts
      exit_code=$?
      echo "Exit Result for C++ Inference Example is ${exit_code}"
     workingDirectory: $(WORK_DIR) 
     displayName: "C++ Inference Example"

   - script: |
      export OPENVINO_TF_BACKEND=GPU
      source ${OV_DIR}/bin/setupvars.sh
      source ${WORK_DIR}/build_cmake/venv-tf-py3/bin/activate
      PYTHONPATH=`pwd` python3 test/ci/azure/test_runner.py \
      --artifacts ${WORK_DIR}/build_cmake/artifacts --test_tf_python
      exit_code=$?
      echo "Exit Result for TF Python Tests OPENVINO_TF_BACKEND is ${exit_code}"
     workingDirectory: $(WORK_DIR) 
     displayName: "TF Python Tests ${OPENVINO_TF_BACKEND}"

   - script: |
      export OPENVINO_TF_BACKEND=GPU
      source ${OV_DIR}/bin/setupvars.sh
      source ${WORK_DIR}/build_cmake/venv-tf-py3/bin/activate
      PYTHONPATH=`pwd`:`pwd`/tools:`pwd`/examples python3 test/ci/azure/test_runner.py \
      --artifacts ${WORK_DIR}/build_cmake/artifacts --test_python
      exit_code=$?
      echo "Exit Result for Python Tests OPENVINO_TF_BACKEND is ${exit_code}"
     workingDirectory: $(WORK_DIR) 
     displayName: "OVTF Python Tests ${OPENVINO_TF_BACKEND}"
     
   - script: |
      rm -rf *
     displayName: "Cleanup"   
     workingDirectory: $(WORK_DIR)
